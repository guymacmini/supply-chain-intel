{% extends "base.html" %}

{% block title %}Saved Research - Supply Chain Intel{% endblock %}

{% block content %}
<h1>Saved Research</h1>

<div class="card">
    <div class="card-header">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
                <h2>Research Watchlist</h2>
                <span class="badge badge-info">{{ saved_items|length }} items</span>
            </div>
            {% if saved_items %}
            <button class="btn btn-success btn-sm" onclick="exportSavedResearchToExcel()" id="saved-research-export-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Export Excel
            </button>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <div class="form-group" style="display: inline-block; margin-right: 1rem;">
            <label for="status-filter">Filter by Status:</label>
            <select id="status-filter" onchange="filterResearch()">
                <option value="">All</option>
                <option value="interested">Interested</option>
                <option value="tracking">Tracking</option>
                <option value="passed">Passed</option>
            </select>
        </div>
        
        <div class="form-group" style="display: inline-block; margin-right: 1rem;">
            <label for="sort-by">Sort by:</label>
            <select id="sort-by" onchange="sortResearch()">
                <option value="saved_date">Date Saved</option>
                <option value="rating">Rating</option>
                <option value="title">Title</option>
                <option value="sector">Sector</option>
            </select>
        </div>
        
        <div class="form-group" style="display: inline-block;">
            <label for="tag-filter">Filter by Tag:</label>
            <input type="text" id="tag-filter" placeholder="Enter tag..." onkeyup="filterByTag()" style="width: 150px;">
        </div>
    </div>

    {% if saved_items %}
    <div id="research-list">
        {% for item in saved_items %}
        <div class="research-item card" style="margin-bottom: 1rem;" 
             data-status="{{ item.status.value }}" 
             data-sector="{{ item.sector or '' }}"
             data-rating="{{ item.rating or 0 }}"
             data-date="{{ item.saved_date }}"
             data-title="{{ item.title }}"
             data-tags="{{ item.tags|join(',') }}">
            
            <div class="card-header" style="display: flex; justify-content: between; align-items: center;">
                <div>
                    <h3 style="margin: 0;">
                        <a href="/research/{{ item.filename }}" style="text-decoration: none;">
                            {{ item.title }}
                        </a>
                    </h3>
                    <div style="font-size: 0.9em; color: #666; margin-top: 0.25rem;">
                        <span>Saved: {{ item.saved_date.split(' ')[0] }}</span>
                        {% if item.sector %}
                            | <span>Sector: {{ item.sector }}</span>
                        {% endif %}
                        {% if item.tickers %}
                            | <span>Tickers: {{ item.tickers|join(', ') }}</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <span class="badge 
                        {% if item.status.value == 'interested' %}badge-info
                        {% elif item.status.value == 'tracking' %}badge-success
                        {% elif item.status.value == 'passed' %}badge-warning
                        {% endif %}">
                        {{ item.status.value.title() }}
                    </span>
                    {% if item.rating %}
                        <span class="badge badge-secondary" style="margin-left: 0.5rem;">
                            {{ 'â˜…' * item.rating }}{{ 'â˜†' * (5 - item.rating) }}
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-body">
                {% if item.tldr %}
                <div class="tldr" style="background: #f5f5f5; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 4px;">
                    <strong>TL;DR:</strong> {{ item.tldr }}
                </div>
                {% endif %}
                
                {% if item.notes %}
                <div class="notes">
                    <strong>Notes:</strong> {{ item.notes }}
                </div>
                {% endif %}
                
                {% if item.tags %}
                <div class="tags" style="margin-top: 0.5rem;">
                    {% for tag in item.tags %}
                    <span class="badge badge-outline" style="margin-right: 0.25rem;">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="actions" style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-sm btn-primary" onclick="editResearch('{{ item.filename }}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="removeResearch('{{ item.filename }}')">Remove</button>
                    <a href="/research/{{ item.filename }}" class="btn btn-sm btn-secondary">View Research</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“š</div>
        <p>No saved research yet. Save interesting research reports from your exploration results!</p>
        <a href="/explore" class="btn btn-primary">Explore Research</a>
    </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Saved Research</h3>
            <button class="btn btn-sm btn-secondary" onclick="closeEditModal()">Ã—</button>
        </div>
        <form id="edit-form">
            <input type="hidden" id="edit-filename">
            
            <div class="form-group">
                <label for="edit-status">Status</label>
                <select id="edit-status" required>
                    <option value="interested">Interested</option>
                    <option value="tracking">Tracking</option>
                    <option value="passed">Passed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="edit-rating">Rating (1-5 stars)</label>
                <select id="edit-rating">
                    <option value="">No rating</option>
                    <option value="1">1 star</option>
                    <option value="2">2 stars</option>
                    <option value="3">3 stars</option>
                    <option value="4">4 stars</option>
                    <option value="5">5 stars</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="edit-tags">Tags (comma-separated)</label>
                <input type="text" id="edit-tags" placeholder="e.g., AI, semiconductors, high-growth">
            </div>
            
            <div class="form-group">
                <label for="edit-notes">Notes</label>
                <textarea id="edit-notes" rows="4" placeholder="Add your thoughts, analysis, or reminders..."></textarea>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
        <div id="edit-status-msg" style="margin-top: 1rem; display: none;"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Filter and sort functionality
function filterResearch() {
    const statusFilter = document.getElementById('status-filter').value;
    const items = document.querySelectorAll('.research-item');
    
    items.forEach(item => {
        const itemStatus = item.getAttribute('data-status');
        const shouldShow = !statusFilter || itemStatus === statusFilter;
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

function sortResearch() {
    const sortBy = document.getElementById('sort-by').value;
    const container = document.getElementById('research-list');
    const items = Array.from(document.querySelectorAll('.research-item'));
    
    items.sort((a, b) => {
        let aVal = a.getAttribute(`data-${sortBy}`);
        let bVal = b.getAttribute(`data-${sortBy}`);
        
        // Handle numeric values
        if (sortBy === 'rating') {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
            return bVal - aVal; // Higher rating first
        }
        
        // Handle date values
        if (sortBy === 'saved_date') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
            return bVal - aVal; // Newer first
        }
        
        // Handle string values
        return (aVal || '').localeCompare(bVal || '');
    });
    
    items.forEach(item => container.appendChild(item));
}

function filterByTag() {
    const tagFilter = document.getElementById('tag-filter').value.toLowerCase();
    const items = document.querySelectorAll('.research-item');
    
    items.forEach(item => {
        const itemTags = item.getAttribute('data-tags').toLowerCase();
        const shouldShow = !tagFilter || itemTags.includes(tagFilter);
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

// Edit functionality
let currentEditFilename = '';

function editResearch(filename) {
    currentEditFilename = filename;
    
    // Get current data from the DOM
    const item = document.querySelector(`[data-title]`);
    const statusBadge = item.querySelector('.badge');
    const notes = item.querySelector('.notes');
    const tags = item.querySelectorAll('.badge-outline');
    const ratingBadge = item.querySelector('.badge-secondary');
    
    // Populate form
    document.getElementById('edit-filename').value = filename;
    
    // Set status from badge class
    if (statusBadge.classList.contains('badge-info')) {
        document.getElementById('edit-status').value = 'interested';
    } else if (statusBadge.classList.contains('badge-success')) {
        document.getElementById('edit-status').value = 'tracking';
    } else if (statusBadge.classList.contains('badge-warning')) {
        document.getElementById('edit-status').value = 'passed';
    }
    
    // Set rating
    if (ratingBadge) {
        const stars = ratingBadge.textContent.match(/â˜…/g);
        document.getElementById('edit-rating').value = stars ? stars.length : '';
    }
    
    // Set tags
    const tagValues = Array.from(tags).map(tag => tag.textContent);
    document.getElementById('edit-tags').value = tagValues.join(', ');
    
    // Set notes
    if (notes) {
        const notesText = notes.textContent.replace('Notes: ', '');
        document.getElementById('edit-notes').value = notesText;
    }
    
    // Show modal
    document.getElementById('edit-modal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('edit-form').reset();
    document.getElementById('edit-status-msg').style.display = 'none';
}

document.getElementById('edit-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const filename = document.getElementById('edit-filename').value;
    const tags = document.getElementById('edit-tags').value;
    const rating = document.getElementById('edit-rating').value;
    
    const updates = {
        status: document.getElementById('edit-status').value,
        notes: document.getElementById('edit-notes').value,
        tags: tags ? tags.split(',').map(t => t.trim()) : [],
        rating: rating ? parseInt(rating) : null
    };
    
    try {
        const response = await fetch(`/api/saved-research/${filename}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updates)
        });
        
        const data = await response.json();
        const statusMsg = document.getElementById('edit-status-msg');
        statusMsg.style.display = 'block';
        
        if (data.success) {
            statusMsg.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            setTimeout(() => {
                closeEditModal();
                location.reload();
            }, 1000);
        } else {
            statusMsg.innerHTML = '<div class="alert alert-error">' + data.message + '</div>';
        }
    } catch (error) {
        const statusMsg = document.getElementById('edit-status-msg');
        statusMsg.style.display = 'block';
        statusMsg.innerHTML = '<div class="alert alert-error">Error: ' + error.message + '</div>';
    }
});

async function removeResearch(filename) {
    if (!confirm('Remove this research from your saved list?')) return;
    
    try {
        const response = await fetch(`/api/saved-research/${filename}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('edit-modal');
    if (event.target === modal) {
        closeEditModal();
    }
}

// Export saved research to Excel
function exportSavedResearchToExcel() {
    const btn = document.getElementById('saved-research-export-btn');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating Excel...';
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = `/export/saved-research/excel`;
    link.download = 'saved_research.xlsx';
    
    // Add event listeners to handle completion
    link.addEventListener('click', function() {
        // Reset button after a short delay
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showToast('Saved research Excel export initiated!');
        }, 1000);
    });
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fade-in`;
    toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; min-width: 200px;';
    
    let icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
    
    toast.innerHTML = `
        <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icon}
        </svg>
        ${message}
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>

<style>
/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.modal-header h3 {
    margin: 0;
}

.modal form {
    padding: 1rem;
}

/* Badge styling */
.badge-outline {
    background: transparent;
    border: 1px solid #007bff;
    color: #007bff;
}

/* Research item styling */
.research-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
}

.tldr {
    font-style: italic;
}
</style>
{% endblock %}